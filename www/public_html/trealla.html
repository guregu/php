<!doctype html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Trealla Prolog playground</title>
	<style>
		body { padding: 10px; }
		#src { width: 100%; max-width: min(95vw, 1200px); font-family: monospace; }
		#result { background-color: #f4f4ff; padding: 0.3em; white-space: pre-wrap; }
		#result:empty { display: none; }
		div#prompt { display: flex; gap: 0.3em; width: min(95vw, 1200px) }
		#prompt input[type=text] { width: 72ch; flex-grow: 1; }
		#prompt label { min-width: 2ch; font-size: 19px; margin-top: auto; }
		#tinker { padding-top: 0.3em; width: min(95vw, 1200px); }
		#tinker > * { margin-bottom: 5px; }
		#tinker { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 1em; }
		#tinker > :nth-child(1) { text-align: left;	}
		#tinker > :nth-child(2) { text-align: right; }
		input, textarea, pre { font-size: 16px; tab-size: 4; quotes: "'" "'"; }
		pre { margin: 0; }
		.query-box[data-state="done"] .query-buttons { display: none; }
		.query-box { background-color: #f4f4ff; padding:0.3em; margin-top:0.3em; border: 1px solid grey; }
		menu { list-style-type: none; padding-inline: 0; margin-block: 0; margin-top: 0.3em; }
		menu li { display: inline; }
		img { max-width: 100%; }
	</style>
</head>
<?
% trealla-js version management

default_version("0.17.10").

npm_version(V) :- query_param(tpl, V).
npm_version(V) :- default_version(V).

% sharing function

source_query(Src, Q) :-
	query_param(share, ID),
	ID \= "",
	setup_call_cleanup(
		sqlite_open(default, Conn),
		(
			sqlite_query(Conn, "SELECT src, q FROM shares WHERE id = ?", [text(ID)], Rows, _),
			Rows = [row(text(Src), text(Q))]
		),
		sqlite_close(Conn)
	).
source_query(Src, Q) :-
	param_or_empty(src, Src),
	param_or_empty(q, Q).

param_or_empty(K, V) :- query_param(K, V).
param_or_empty(K, V) :- form_value(K, V).
param_or_empty(K, "").

:- source_query(Source, Query), assertz(source(Source)), assertz(query(Query)).
?>
<body>
<h2>Trealla Playground</h2>
<p>Run Prolog in your browser. Press escape then tab to escape the text editor.</p>
<form onsubmit="return ask && ask(), false;">
	<textarea cols=80 rows=20 id="src" spellcheck="false" placeholder="person(socrates).
mortal(X) :- person(X)."><?=X source(X). ?></textarea><br>
	<div id="prompt">
		<label for="query">?- </label><input type="text" placeholder="mortal(Who)." value='<?=X query(X). ?>' id="query" required>
		<input type="submit" value="Loading..." id="query-btn" spellcheck="false" disabled>
	</div>
</form>

<section id="tinker" style="text-align: right;">
	<div>
		<button onclick="return shareCode(this),false;">💾 Share</button>
		<span id="shared"></span>
	</div>
	<div>
		<label for="format">format:</label> <select id="format">
			<option value="prolog" selected>prolog</option>
			<option value="json">json</option>
		</select>
		<br>
		<button onclick="return resetProlog(),false;">Reset Interpreter</button> <br>
	</div>
</section>

<section id="queries"></section>

<template id="query-tmpl">
	<div class="query-box">
		<pre class="query-result"></pre>
		<menu class="query-buttons">
			<li><button class="query-next">Next</button></li>
			<li><button class="query-all">All</button></li>
			<li><button class="query-stop">Stop</button></li>
		</menu>
	</div>
</template>

<section>
	<h2>More Info</h2>
	<ul>
		<li><a href="https://github.com/trealla-prolog/trealla">Trealla Prolog</a></li>
		<li>
			<a href="https://github.com/guregu/trealla-js">trealla-js</a>
			<ul>
			<?if npm_version(V). ?>
				<li>
					currently using version: <a href="https://www.npmjs.com/package/trealla/v/<?=V ?>" target="_blank"><?=V ?></a>
				</li>
				<li>
					<form action="" method="GET" target="_blank">
						<label for="tpl-version">use version: </label>
						<?if query_param(share, Share). ?>
							<input type="hidden" name="share" value="<?=Share ?>">
						<?end ?>
						<input type="text" name="tpl" id="tpl-version" placeholder="<?=V ?>" size=7 required>
						<input type="submit" value="Go">
					</form>
				</li>
				<li><a href="https://www.npmjs.com/package/trealla?activeTab=versions" target="_blank">all versions</a></li>
			<?end ?>
			</ul>
		</li>
	</ul>
	<br>
	<img src="/assets/trealla.png">
</section>

<footer>
powered by <a href="https://github.com/trealla-prolog/trealla">Trealla Prolog</a>
</footer>

<script type="module">
import { load, Prolog, toJSON } from 'https://esm.sh/trealla@<?=V npm_version(V). ?>?target=es2018';

try {
	load().then(init);
} catch(err) {
	alert(err);
}

let pl = null;

function init() {
	try {
		pl = new Prolog();
	} catch(err) {
		alert(err);
		throw err;
	}

	// TODO: replace with actual code editor
	let escaping = false;
	document.getElementById("src").addEventListener("keydown", function(e) {
		switch (e.key) {
		case "Escape":
			escaping = true;
			break;
		case "Tab":
			if (escaping) {
				escaping = false;
				break;
			}
			e.preventDefault()
			e.target.setRangeText("\t",	e.target.selectionStart, e.target.selectionStart, "end");
			break;
		case "Enter":
			const caret = e.target.selectionStart;
			const lineStart = e.target.value.lastIndexOf("\n", caret-1) + 1;
			const line = e.target.value.slice(lineStart, caret);
			let ct = 0;
			if ((line.startsWith("\t") || (line.endsWith(":-") && ++ct) || (line.endsWith("-->") && ++ct)) &&
				 !line.trim().endsWith(".")) {
				for (let i = 0; i < line.length && line[i] == "\t"; ct++,i++) {}
				const tab = "\t".repeat(ct);
				e.preventDefault();
				e.target.setRangeText("\n" + tab, e.target.selectionStart, e.target.selectionStart,	"end");
			}
		default:
			escaping = false;
		}
	});

	document.getElementById("query-btn").removeAttribute("disabled");
	document.getElementById("query-btn").value = "Query";
}

window.resetProlog = function() {
	init();
}

window.ask = async function ask() {
	try {
		await run();
	} catch(error) {
		alert(error);
		console.error(error);
	}
}

let ID = 0;
async function run() {
	const query = getQuery();
	const src = document.getElementById("src").value;
	const format = document.getElementById("format").value;
	let text = "?- " + query + "\n";
	let n = 0;
	const encode = format == "prolog" ? {dot: false} : undefined;
	const q = pl.query(query, {program: src, format: format, encode: encode});
	const id = ++ID;
	QUERIES[id] = q;

	const elem = document.getElementById("query-tmpl").content.cloneNode(true);
	const box = elem.querySelector(".query-box");
	box.id = `query-${id}`;
	box.dataset.format = format;
	elem.querySelector(".query-result").textContent = "?- " + query + "\n";
	elem.querySelector(".query-next").onclick = next.bind(elem, id);
	elem.querySelector(".query-all").onclick = all.bind(elem, id);
	elem.querySelector(".query-stop").onclick = stop.bind(elem, id);
	document.getElementById("queries").prepend(elem);
	await next(id);
}

function getQuery() {
	return document.getElementById("query").value.replaceAll(`“`, `"`).replaceAll(`”`, `"`).replaceAll(`‘`, `'`).replaceAll(`’`, `'`);
}

const QUERIES = {};

async function next(id) {
	const elem = document.getElementById("query-" + id);
	if (!elem) return;
	const ok = await redo(id, elem);
	if (!ok) {
		elem.dataset.state = "done";
	}
}

async function all(id) {
	const elem = document.getElementById("query-" + id);
	if (!elem) return;
	const limit = 10000;
	for (var i = 0; i <= limit && await redo(id, elem); i++) {};
	if (i > limit) {
		elem.querySelector(".query-result").textContent += `\n% paused after ${limit} results`
	} else {
		elem.dataset.state = "done";
	}
}

async function redo(id, elem) {
	const q = QUERIES[id];
	if (!q) return false;
	let result;
	try {
		console.time("query");
		result = (await q.next()).value;
	} catch(error) {
		alert(error);
		console.error(error);
		return false;
	} finally {
		console.timeEnd("query");
	}
	const stdout = elem.querySelector(".query-result");
	if (!result) {
		delete QUERIES[id];
		if (elem.dataset.format !== "json")
			stdout.textContent += ".";
		return false;
	}
	const n = Number(elem.dataset.n ?? 0);
	if (typeof result === "string")
		stdout.textContent += (n > 0 ? "\n;  " : "   ") + result;
	else
		stdout.textContent += toJSON(result, " ") + "\n";
	elem.dataset.n = n+1;
	return true;
}

function stop(id) {
	const elem = document.getElementById("query-" + id);
	if (!elem) return;
	const q = QUERIES[id];
	if (!q) return false;
	delete QUERIES[id];
	q.return();
	elem.querySelector(".query-result").textContent += ".\n% stopped"
	elem.dataset.state = "done";
}

window.updateURL = function() {
	const query = document.getElementById("query");
	const src = document.getElementById("src");
	const url = new URL(document.URL);
	if (src.value.length < 10 * 1024) {
		url.searchParams.set("src", src.value);
	} else {
		url.searchParams.delete("src");
	}
	url.searchParams.set("q", query.value);
	url.searchParams.set("v", "0");
	history.replaceState(query.value, "", url.toString());
}

window.shareCode = async function(elem) {
	elem.disabled = true;

	const shared = document.getElementById("shared");
	const query = document.getElementById("query");
	const src = document.getElementById("src");
	const url = new URL(document.URL);
	const data = new FormData();
	data.append("src", src.value);
	data.append("q", query.value);
	try {
		shared.textContent = "⏳";
		const got = await fetch("/trealla_share.html", {
			method: "POST",
			headers: { "Content-Type": "application/x-www-form-urlencoded" },
			body: new URLSearchParams(data).toString()
		});
		const html = await got.text();
		shared.innerHTML = html;
		const link = document.querySelector("#shared a:first-of-type").href;
		if (link) {
			history.replaceState(query.value, "", link);
		}
	} catch (ex) {
		shared.textContent = `Share error: ${ex}`;
	} finally {
		elem.disabled = false;
	}
}
</script>
</body>
</html>
