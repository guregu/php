<!doctype html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Trealla Prolog playground</title>
	<style>
		#src { width: 100%; max-width: 95vw; }
		#result { background-color: #f4f4ff; padding: 0.3em; }
		#result:empty { display: none; }
		div#prompt { display: flex; gap: 0.3em; }
		#prompt input[type=text] { width: 72ch; flex-grow: 1; }
		#prompt label { min-width: 2ch; }
		#tinker { padding-top: 0.3em; }
	</style>
</head>
<body>
<h2>Trealla Playground</h2>
<form onsubmit="return ask && ask().then(updateURL), false;">
	<textarea cols=80 rows=20 id="src" placeholder="person(socrates).
mortal(X) :- person(X)."><?=X query_param(src, X) ?></textarea><br>
	<div id="prompt">
		<label for="query">?- </label><input type="text" placeholder="mortal(Who)." value="<?=X query_param(q, X) ?>" id="query" required>
		<input type="submit" value="Loading..." id="query-btn" disabled>
	</div>
</form>

<section id="tinker" style="text-align: right;">
	<label for="format">format:</label> <select id="format">
		<option value="prolog" selected>prolog</option>
		<option value="json">json</option>
	</select>
	<button onclick="return resetProlog(),false;">Reset Interpreter</button> <br>
</section>

<pre id="result"></pre>

<section>
	<h2>More Info</h2>
	<ul>
		<li><a href="https://github.com/trealla-prolog/trealla">Trealla Prolog</a></li>
		<li><a href="https://github.com/guregu/trealla-js">trealla-js</a></li>
	</ul>
</section>

<footer>
powered by <a href="https://github.com/trealla-prolog/trealla">Trealla Prolog</a>
</footer>

<script type="module">
import { loadFromWAPM, Prolog } from 'https://esm.sh/trealla@0.9.1';

await loadFromWAPM("0.7.1");

let pl = new Prolog();

window.resetProlog = function() {
	pl = new Prolog();
}

window.ask = async function ask() {
	try {
		await run()
	} catch(error) {
		alert(error);
	}
}

async function run() {
	const query = document.getElementById("query");
	const src = document.getElementById("src");
	const result = document.getElementById("result");
	const format = document.getElementById("format").value;
	result.textContent = "";
	console.time("query");
	let text = "?- " + query.value + "\n";
	let n = 0;
	const encode = format == "prolog" ? {dot: false} : undefined;
	for await (const msg of pl.query(query.value, {program: src.value, format: format, encode: encode})) {
		console.timeEnd("query");
		if (typeof msg === "string")
			text += (n > 0 ? "\n;  " : "   ") + msg;
		else
			text += JSON.stringify(msg, undefined, " ") + "\n";
		n++;
		console.time("query");
	}
	if (format === "prolog") text += ".";
	console.timeEnd("query");
	result.textContent = text;
}

window.updateURL = function() {
	const query = document.getElementById("query");
	const src = document.getElementById("src");
	var url = new URL(document.URL);
	if (src.value.length < 10 * 1024) {
		url.searchParams.set("src", src.value);
	} else {
		url.searchParams.delete("src");
	}
	url.searchParams.set("q", query.value);
	url.searchParams.set("v", "0");
	history.replaceState(query.value, "", url.toString());
}

document.getElementById("query-btn").removeAttribute("disabled");
document.getElementById("query-btn").value = "Query";
</script>
</body>
</html>