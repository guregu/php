<!doctype html>
<html>
<head>
	<title>Trealla Prolog playground</title>
</head>
<body>
<h2>Trealla playground</h2>
<form onsubmit="return ask(), updateURL(), false;">
	<textarea cols=80 rows=20 id="src" placeholder="person(socrates).
mortal(X) :- person(X)."><?=X query_param(src, X) ?></textarea><br>
	<input type="text" style="width: 74ch" placeholder="mortal(Who)." value="<?=X query_param(q, X) ?>" id="query" required>
	<input type="submit" value="Query" id="query-btn" disabled>
	<style>pre { background-color: #f4f4ff; padding: 0.3em; } pre:empty { display: none; } </style>
</form>

<section style="text-align: right;">
	<button onclick="return resetProlog(),false;">Reset Interpreter</button> <br>
	<label for="format">format:</label> <select id="format">
		<option value="prolog" selected>prolog</option>
		<option value="js">json</option>
	</select>
</section>

<pre id="result"></pre>

<section>
	<h2>more info</h2>
	<ul>
		<li><a href="https://github.com/trealla-prolog/trealla">trealla prolog</a></li>
		<li><a href="https://github.com/guregu/trealla-js">trealla-js</a></li>
	</ul>
</section>

<footer>
powered by <a href="https://github.com/trealla-prolog/trealla">trealla prolog</a>
</footer>

<script>
var QUERY = document.getElementById("query");
var SRC = document.getElementById("src");
var RESULT = document.getElementById("result");

function updateURL() {
	var url = new URL(document.URL);
	if (SRC.value.length < 10 * 1024) {
		url.searchParams.set("src", SRC.value);
	} else {
		url.searchParams.delete("src");
	}
	url.searchParams.set("q", QUERY.value);
	url.searchParams.set("v", "0");
	history.replaceState(QUERY.value, "", url.toString());
}
</script>

<script type="module">
import { loadFromWAPM, Prolog } from 'https://esm.sh/trealla@0.9.0';

await loadFromWAPM("0.7.1");

let pl = new Prolog();

window.resetProlog = function() {
	pl = new Prolog();
}

window.ask = async function ask() {
	const query = document.getElementById("query");
	const src = document.getElementById("src");
	const result = document.getElementById("result");
	const format = document.getElementById("format").value;
	result.textContent = "";
	console.time("query");
	let text = "?- " + query.value + "\n";
	let n = 0;
	const encode = format == "prolog" ? {dot: false} : undefined;
	for await (const msg of pl.query(query.value, {program: src.value, format: format, encode: encode})) {
		console.timeEnd("query");
		if (typeof msg === "string")
			text += (n > 0 ? "\n;  " : "   ") + msg.slice(0, -1);
		else
			text += JSON.stringify(msg, undefined, " ") + "\n";
		n++;
		console.time("query");
	}
	if (format === "prolog") text += ".";
	console.timeEnd("query");
	result.textContent = text;
}

document.getElementById("query-btn").removeAttribute("disabled");
</script>
</body>
</html>